<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Place 3D on Image</title>

<style>
  :root { color-scheme: dark; }
  html,body { margin:0; height:100%; background:#0b0b0f; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
  #app { display:flex; flex-direction:column; height:100%; }

  /* Status bar */
  #statusBar { background:#10131a; padding:8px 12px; font-size:14px; color:#9fb1ff; border-bottom:1px solid #1c202a; }

  /* Controls */
  #controls { background:#141821; padding:10px; display:flex; flex-direction:column; gap:10px; }
  #controls label { font-size:14px; color:#9fb1ff; }
  #controls select, #controls input[type=file], #controls button, #controls input[type=range] {
    width:100%; height:44px; font-size:15px; border-radius:8px; border:none;
  }
  #controls select, #controls input[type=file] { background:#1d2230; color:#fff; }
  #controls button { background:#2563ff; color:#fff; font-weight:600; }
  #controls button.secondary { background:#2a2f3b; color:#fff; }
  #controls .row { display:flex; gap:8px; }
  #controls .row button { flex:1; }

  /* Stage */
  #stage { flex:1; position:relative; background:#000; display:flex; align-items:center; justify-content:center; }
  #bg { max-width:100%; max-height:100%; object-fit:contain; display:none; }
  #threeCanvas { position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none; }

  /* Bottom bar */
  #bottomBar { padding:10px; background:#10131a; border-top:1px solid #1c202a; }
  #btnSave { width:100%; height:50px; border-radius:10px; font-size:16px; font-weight:600; background:#2563ff; color:#fff; border:none; }
</style>

<script type="importmap">
{
  "imports": {
    "three": "./lib/three/build/three.module.js",
    "three/addons/": "./lib/three/examples/jsm/"
  }
}
</script>
</head>
<body>
<div id="app">

  <!-- Status -->
  <div id="statusBar">bootâ€¦</div>

  <!-- Controls -->
  <div id="controls">
    <div>
      <label>Step 1: Pick Image</label>
      <input id="bgFile" type="file" accept="image/*">
    </div>

    <div>
      <label>Step 2: Pick Model</label>
      <select id="modelSelect" disabled><option>Loadingâ€¦</option></select>
      <button id="btnAdd" disabled>âž• Add Model</button>
    </div>

    <div class="row">
      <button id="btnDelete" class="secondary" disabled>ðŸ—‘ Delete</button>
      <button id="btnClear" class="secondary" disabled>â™» Clear All</button>
    </div>

    <div>
      <label>Scale</label>
      <input id="scale" type="range" min="0.05" max="5" step="0.01" value="1">
    </div>

    <div class="row">
      <button id="btnRotL" class="secondary">âŸ² Rotate</button>
      <button id="btnRotR" class="secondary">âŸ³ Rotate</button>
    </div>
  </div>

  <!-- Stage -->
  <div id="stage">
    <img id="bg" alt="background">
    <canvas id="threeCanvas"></canvas>
  </div>

  <!-- Bottom -->
  <div id="bottomBar">
    <button id="btnSave">â¬‡ Download PNG</button>
  </div>

</div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

const ui = {
  status: document.getElementById('statusBar'),
  bgFile: document.getElementById('bgFile'),
  bg: document.getElementById('bg'),
  modelSel: document.getElementById('modelSelect'),
  add: document.getElementById('btnAdd'),
  del: document.getElementById('btnDelete'),
  clear: document.getElementById('btnClear'),
  save: document.getElementById('btnSave'),
  scale: document.getElementById('scale'),
  rotL: document.getElementById('btnRotL'),
  rotR: document.getElementById('btnRotR'),
  canvas: document.getElementById('threeCanvas')
};
function setStatus(t){ ui.status.textContent=t; }

let renderer, scene, camera, raycaster, plane, pointer=new THREE.Vector2();
let catalog=[], placed=[], selected=null;

renderer=new THREE.WebGLRenderer({canvas:ui.canvas, antialias:true, alpha:true, preserveDrawingBuffer:true});
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
scene=new THREE.Scene();
camera=new THREE.OrthographicCamera(-400,400,300,-300,0.1,1000);
camera.position.set(0,0,10);
scene.add(new THREE.AmbientLight(0xffffff,1));

plane=new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({transparent:true,opacity:0}));
scene.add(plane);
raycaster=new THREE.Raycaster();

function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera);} animate();

// Catalog
const draco=new DRACOLoader().setDecoderPath('./lib/three/examples/jsm/libs/draco/');
const gltf=new GLTFLoader().setDRACOLoader(draco);
async function loadCatalog(){
  try{
    const res=await fetch('./models/models.json',{cache:'no-cache'});
    catalog=await res.json();
    ui.modelSel.innerHTML='';
    catalog.forEach((m,i)=>{const o=document.createElement('option');o.value=i;o.textContent=m.name;ui.modelSel.appendChild(o);});
    ui.modelSel.disabled=false; ui.add.disabled=false;
    setStatus('âœ… Catalog loaded');
  }catch{ setStatus('âš  Failed to load catalog'); }
}
loadCatalog();

// Background
ui.bgFile.onchange=e=>{
  const file=e.target.files[0]; if(!file)return;
  const url=URL.createObjectURL(file);
  ui.bg.src=url; ui.bg.style.display='block';
  ui.bg.onload=()=>{
    const w=ui.bg.naturalWidth,h=ui.bg.naturalHeight;
    renderer.setSize(ui.stageW=w,ui.stageH=h);
    camera.left=-w/2;camera.right=w/2;camera.top=h/2;camera.bottom=-h/2;camera.updateProjectionMatrix();
    plane.scale.set(w,h,1);
    setStatus('âœ… Image loaded. Step 2: Add model.');
  };
};

// Add model
ui.add.onclick=async()=>{
  const item=catalog[ui.modelSel.value]; if(!item)return;
  setStatus('Loading '+item.name+'â€¦');
  const glb=await gltf.loadAsync(item.url); const obj=glb.scene;
  obj.scale.setScalar(item.scale||1); obj.position.set(0,0,0);
  scene.add(obj); placed.push(obj); select(obj);
  setStatus('Tap & drag to move â€¢ pinch/slider to scale');
};

// Selection
function select(o){ selected=o; if(o){ui.del.disabled=false;} else {ui.del.disabled=true;} }
renderer.domElement.addEventListener('pointerdown',e=>{
  setPointer(e);const hit=pick(pointer); if(hit){select(hit.object.parent);} else select(null);
});
renderer.domElement.addEventListener('pointermove',e=>{
  if(!selected||e.buttons!==1)return; setPointer(e); const p=planeHit(pointer); if(p)selected.position.copy(p);
});
function setPointer(e){const r=ui.canvas.getBoundingClientRect(); pointer.x=((e.clientX-r.left)/r.width)*2-1; pointer.y=-((e.clientY-r.top)/r.height)*2+1;}
function planeHit(ndc){raycaster.setFromCamera(ndc,camera);const h=raycaster.intersectObject(plane)[0];return h?h.point:null;}
function pick(ndc){raycaster.setFromCamera(ndc,camera);const h=raycaster.intersectObjects(placed,true);return h?.[0]||null;}

// Scale + rotate
ui.scale.oninput=()=>{ if(selected){const s=Number(ui.scale.value); selected.scale.setScalar(s);} };
ui.rotL.onclick=()=>{ if(selected)selected.rotation.y+=THREE.MathUtils.degToRad(-15); };
ui.rotR.onclick=()=>{ if(selected)selected.rotation.y+=THREE.MathUtils.degToRad(15); };

// Delete/Clear
ui.del.onclick=()=>{ if(selected){scene.remove(selected); placed=placed.filter(p=>p!==selected); select(null);} };
ui.clear.onclick=()=>{ placed.forEach(o=>scene.remove(o)); placed=[]; select(null); };

// Save
ui.save.onclick=()=>{
  const cvs=document.createElement('canvas');cvs.width=renderer.domElement.width;cvs.height=renderer.domElement.height;
  const ctx=cvs.getContext('2d');ctx.drawImage(ui.bg,0,0,cvs.width,cvs.height);ctx.drawImage(renderer.domElement,0,0);
  const a=document.createElement('a');a.href=cvs.toDataURL('image/png');a.download='composite.png';a.click();
};
</script>
</body>
</html>
