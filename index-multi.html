<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>AR Catalog ‚Äî Mobile</title>
<style>
  :root { color-scheme: dark; }
  html, body { margin:0; height:100%; background:#0b0b0f; font:15px system-ui, -apple-system, Segoe UI, Roboto; color:#eaeaf1;}

  #status { position:fixed; left:0; right:0; top:0; text-align:left; font:12px ui-monospace; color:#9aa0a6;
            padding:4px 10px; background:#1a1c22; z-index:1000; }

  /* Collapsible HUD */
  #hud { position:fixed; top:28px; left:0; right:0; background:rgba(10,10,12,.9);
         backdrop-filter:blur(6px); padding:10px; z-index:100; }
  #hud.collapsed { display:none; }
  #hud select, #hud button { width:100%; height:44px; margin-top:6px; border-radius:10px; border:1px solid #2a2e36;
                             background:#14161b; color:#fff; font-size:15px; }
  #hud button.primary { background:#2563ff; border-color:#2563ff; }
  #hud button.ghost   { background:#191b22; }

  /* Bottom bar */
  #bottomBar { position:fixed; bottom:0; left:0; right:0; background:rgba(10,10,12,.95);
               padding:8px; display:flex; gap:8px; z-index:200; }
  #bottomBar button { flex:1; height:48px; border-radius:12px; border:none; font-size:15px; font-weight:600; }
  #btnEnterAR { background:#2563ff; color:#fff; }
  #btnAdd, #btnUndo, #btnClear { background:#2d2f36; color:#fff; }

  /* Edit floating toolbar */
  #editHud { display:none; position:fixed; bottom:70px; left:50%; transform:translateX(-50%);
             background:rgba(0,0,0,.7); padding:10px; border-radius:12px; display:flex; gap:8px; z-index:300; }
  #editHud button { height:40px; border-radius:8px; border:none; padding:0 12px; background:#2a2f36; color:#fff; }

  #reticle { position:fixed; width:44px; height:44px; left:calc(50% - 22px); top:calc(50% - 22px);
             border:4px solid #1ea0ff; border-radius:50%; opacity:0; pointer-events:none; transition:opacity .18s ease; }
  #hint { position:fixed; left:50%; transform:translateX(-50%); bottom:130px; font-size:13px; color:#c9d1d9; opacity:.9; z-index:250; }
  canvas { width:100vw; height:100vh; display:block; touch-action:none; }
</style>

<script type="importmap">
{
  "imports": {
    "three": "./lib/three/build/three.module.js",
    "three/addons/": "./lib/three/examples/jsm/"
  }
}
</script>
</head>
<body>

<div id="status">boot‚Ä¶</div>

<!-- Collapsible HUD -->
<div id="hud">
  <select id="modelSel"><option>Loading‚Ä¶</option></select>
  <button id="btnShot" class="ghost">üì∏ Snapshot</button>
  <button id="btnRec" class="ghost">‚è∫ Start</button>
</div>

<!-- Reticle + hint -->
<div id="reticle"></div>
<div id="hint" hidden>Tap where the ring is to place</div>

<!-- Bottom bar -->
<div id="bottomBar">
  <button id="btnAdd">+ Add</button>
  <button id="btnUndo">‚Ü∫ Undo</button>
  <button id="btnClear">üóë Clear</button>
  <button id="btnEnterAR">üì∑ Enter AR</button>
</div>

<!-- Edit HUD -->
<div id="editHud">
  <button id="rotL">‚óÄ</button>
  <button id="rotR">‚ñ∂</button>
  <button id="sMinus">‚àí</button>
  <button id="sPlus">Ôºã</button>
  <button id="btnLock">üîí</button>
</div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader }  from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

const $ = id => document.getElementById(id);
const statusEl = $('status');
const modelSel = $('modelSel');
const btnAdd   = $('btnAdd');
const btnUndo  = $('btnUndo');
const btnClear = $('btnClear');
const btnEnter = $('btnEnterAR');
const btnShot  = $('btnShot');
const btnRec   = $('btnRec');
const editHud  = $('editHud');
const rotL = $('rotL'), rotR = $('rotR'), sMinus=$('sMinus'), sPlus=$('sPlus'), btnLock=$('btnLock');
const hintEl = $('hint'), reticleEl=$('reticle');

function setStatus(t){ statusEl.textContent = t; }
function showReticle(show){ reticleEl.style.opacity = show?1:0; reticle3D.visible=show; }
function showHint(t){ hintEl.textContent=t; hintEl.hidden=false; }
function hideHint(){ hintEl.hidden=true; }

// Three.js setup
const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true,preserveDrawingBuffer:true});
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled=true;
renderer.outputColorSpace=THREE.SRGBColorSpace;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.01, 40);
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

const reticle3D = new THREE.Mesh(
  new THREE.RingGeometry(0.12,0.15,32).rotateX(-Math.PI/2),
  new THREE.MeshBasicMaterial({color:0x1ea0ff})
);
reticle3D.visible=false;
scene.add(reticle3D);

const draco = new DRACOLoader().setDecoderPath('./lib/three/examples/jsm/libs/draco/');
const gltf = new GLTFLoader().setDRACOLoader(draco);

let catalog=[], placed=[], active=null, editing=false, locked=false;
let xrSession=null, xrRefSpace=null, viewerSpace=null, hitTestSource=null, arReady=false;

async function loadCatalog(){
  try{
    const res=await fetch('./models/models.json',{cache:'no-cache'});
    catalog=await res.json();
    modelSel.innerHTML='';
    for(const item of catalog){
      const o=document.createElement('option'); o.value=item.url; o.textContent=item.name; modelSel.appendChild(o);
    }
    setStatus(`catalog loaded (${catalog.length})`);
  }catch(e){ setStatus('catalog load failed'); }
}
await loadCatalog();

btnEnter.onclick=async()=>{
  if(xrSession){ xrSession.end(); return; }
  if(!navigator.xr) return alert('WebXR not available');
  if(!await navigator.xr.isSessionSupported('immersive-ar')) return alert('immersive-ar not supported');
  xrSession=await navigator.xr.requestSession('immersive-ar',{requiredFeatures:['hit-test','local-floor']});
  renderer.xr.setSession(xrSession);
  xrRefSpace=await xrSession.requestReferenceSpace('local-floor');
  viewerSpace=await xrSession.requestReferenceSpace('viewer');
  hitTestSource=await xrSession.requestHitTestSource({space:viewerSpace});
  xrSession.addEventListener('end',()=>{ xrSession=null; hitTestSource=null; setStatus('ended'); showReticle(false); hideHint(); editHud.style.display='none'; });
  xrSession.addEventListener('select', onARSelect);
  btnEnter.textContent='‚èª Exit';
  setStatus('AR started'); showHint('Tap Add then tap reticle');
  renderer.setAnimationLoop(onXRFrame);
};

function onXRFrame(t,frame){
  if(frame && hitTestSource && xrRefSpace){
    const hits=frame.getHitTestResults(hitTestSource);
    if(hits.length){ const pose=hits[0].getPose(xrRefSpace); reticle3D.matrix.fromArray(pose.transform.matrix); reticle3D.matrix.decompose(reticle3D.position,reticle3D.quaternion,reticle3D.scale); showReticle(true);} else showReticle(false);
  }
  renderer.render(scene,camera);
}

btnAdd.onclick=()=>{ if(!xrSession)return alert('Enter AR first'); arReady=true; showHint('Tap once to place'); };
async function onARSelect(){
  if(!arReady||!reticle3D.visible||locked)return;
  const choice=catalog[modelSel.selectedIndex]; if(!choice)return;
  const obj=(await gltf.loadAsync(choice.url)).scene;
  obj.scale.setScalar(choice.scale??1);
  obj.applyMatrix4(reticle3D.matrix);
  scene.add(obj); placed.push(obj); active=obj;
  editing=true; editHud.style.display='flex'; arReady=false;
  setStatus('placed');
}

btnUndo.onclick=()=>{ const o=placed.pop(); if(o)scene.remove(o); active=null; editHud.style.display='none'; };
btnClear.onclick=()=>{ placed.forEach(o=>scene.remove(o)); placed=[]; active=null; editHud.style.display='none'; };

rotL.onclick=()=>{ if(active)active.rotation.y-=Math.PI/18; };
rotR.onclick=()=>{ if(active)active.rotation.y+=Math.PI/18; };
sMinus.onclick=()=>{ if(active)active.scale.multiplyScalar(0.9); };
sPlus.onclick=()=>{ if(active)active.scale.multiplyScalar(1.1); };
btnLock.onclick=()=>{ locked=!locked; btnLock.textContent=locked?'üîì':'üîí'; };

btnShot.onclick=()=>{ const url=renderer.domElement.toDataURL('image/png'); const a=document.createElement('a'); a.href=url;a.download='ar-shot.png';a.click(); };

let rec=null,chunks=[];
btnRec.onclick=()=>{
  if(rec){ rec.stop(); rec=null; btnRec.textContent='‚è∫ Start'; return; }
  const stream=renderer.domElement.captureStream(30); if(!stream)return alert('Recording not supported');
  rec=new MediaRecorder(stream); rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{ const blob=new Blob(chunks,{type:'video/webm'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ar-rec.webm'; a.click(); chunks=[]; };
  rec.start(); btnRec.textContent='‚èπ Stop';
};

addEventListener('resize',()=>{ renderer.setSize(innerWidth,innerHeight); camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); });
</script>
</body>
</html>
