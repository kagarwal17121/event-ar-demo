<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Event AR — Multi</title>
<style>
  :root { color-scheme: dark; }
  html,body { margin:0; height:100%; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  /* log strip */
  #log {
    position: fixed; top:0; left:0; right:0;
    background: rgba(40,40,40,.95); color:#ddd; font-size:12px; padding:.45rem .6rem;
    z-index: 30; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  /* toolbar */
  #ui {
    position: fixed; top:34px; left:0; right:0; background:#0d0d0d;
    padding: .6rem .7rem .5rem; display:flex; gap:.6rem; align-items:center; z-index:20;
    border-bottom: 1px solid #222;
  }
  #modelSel { flex:1; height:40px; border-radius:10px; padding:0 .7rem; border:1px solid #333; background:#111; color:#fff; }
  .btn {
    height:40px; padding:0 18px; border-radius:12px; border:1px solid #2a62ff;
    background:#1f5bff; color:#fff; font-weight:600; letter-spacing:.2px;
  }
  .btn.alt { border-color:#444; background:#1a1a1a; }
  .btn.danger { border-color:#7a2b2b; background:#2b1a1a; }
  canvas { display:block; }
  #enterAR {
    position: fixed; bottom: 24px; left:50%; transform: translateX(-50%);
    height:56px; padding:0 22px; border-radius:18px; background:#1f5bff; color:#fff;
    border:1px solid #2a62ff; font-size:18px; font-weight:700; z-index:25;
    display:flex; align-items:center; gap:.6rem;
  }
  #hint {
    position: fixed; bottom: 92px; left:50%; transform:translateX(-50%);
    background: rgba(0,0,0,.55); color:#fff; padding:.45rem .7rem; font-size:13px; border-radius:10px; z-index:24;
    opacity:0; transition: opacity .25s;
  }
  #hint.show { opacity:1; }
  /* reticle visibility hint on non-AR */
  #fallback { position: absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#999 }
</style>
</head>
<body>

<div id="log">boot…</div>

<div id="ui">
  <label style="color:#aaa;margin-right:.35rem">Model</label>
  <select id="modelSel" aria-label="Choose model"><option>Loading…</option></select>
  <button id="btnAdd" class="btn">＋ Add</button>
  <button id="btnUndo" class="btn alt">↶ Undo</button>
  <button id="btnClear" class="btn danger">🗑 Clear</button>
</div>

<div id="hint">Move phone to find a surface, then tap to place.</div>

<button id="enterAR">📷 Enter AR</button>

<div id="fallback" hidden>Initializing…</div>

<script type="module">
/* ---------- Imports (local, no external CDN) ---------- */
import * as THREE from './lib/three/three.module.js';
import { GLTFLoader }    from './lib/three/examples/jsm/loaders/GLTFLoader.js';
import { DRACOLoader }   from './lib/three/examples/jsm/loaders/DRACOLoader.js';

/* ---------- Inline catalog (edit below to add/remove models) ---------- */
const CATALOG = [
  { name: 'Podium',        url: './models/podium.glb' },
  { name: 'Concert Stage', url: './models/concert-stage.glb' },
  { name: 'Chair',         url: './models/chair.glb' },
  { name: 'Couch',         url: './models/couch.glb' },
  { name: 'Chaise',        url: './models/chaisehighpoly.glb' },
];

/* ---------- UI helpers ---------- */
const $ = (q)=>document.querySelector(q);
const logEl = $('#log');
function log(msg){ const t=new Date().toTimeString().slice(0,8); logEl.textContent = `${t} — ${msg}`; }
function setHint(msg, show=true){ const h=$('#hint'); h.textContent=msg; h.classList.toggle('show', show); }

/* ---------- Populate model dropdown immediately (no fetch) ---------- */
const sel = $('#modelSel');
sel.innerHTML = '';
for (const item of CATALOG) {
  const opt = document.createElement('option');
  opt.value = item.url; opt.textContent = item.name;
  sel.appendChild(opt);
}
log(`Catalog loaded (${CATALOG.length} items)`);

/* ---------- THREE scene (shared for AR + fallback) ---------- */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 50);

const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:'high-performance' });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(0.5, 1, 0.5);
scene.add(dir);

/* Reticle */
const reticle = new THREE.Mesh(
  new THREE.RingGeometry(0.25, 0.3, 48).rotateX(-Math.PI/2),
  new THREE.MeshBasicMaterial({ color: 0x00a2ff, transparent:true, opacity:0.9 })
);
reticle.matrixAutoUpdate = false;
reticle.visible = false;
scene.add(reticle);

/* ---------- Loaders ---------- */
const gltfLoader = new GLTFLoader();
const dracoLoader = new DRACOLoader();
dracoLoader.setDecoderPath('./lib/three/examples/jsm/libs/draco/'); // must contain draco_decoder.wasm
gltfLoader.setDRACOLoader(dracoLoader);

/* ---------- Placement state ---------- */
let currentGLTF = null;
let hitTestSource = null;
let hitTestSourceRequested = false;
let xrRefSpace = null;
const placed = []; // stack for undo/clear

/* ---------- Model load helper ---------- */
async function loadSelectedGLB(){
  const url = sel.value;
  log(`loading model: ${url}`);
  return new Promise((resolve, reject)=>{
    gltfLoader.load(url, (gltf)=>{
      // Small defaults (scale per your asset size)
      const root = gltf.scene || gltf.scenes[0];
      root.traverse(o=>{
        if (o.isMesh){ o.castShadow = o.receiveShadow = true; o.frustumCulled = false; }
      });
      // Auto-scale very large/small assets into ~1m bounding box
      const box = new THREE.Box3().setFromObject(root);
      const size = new THREE.Vector3(); box.getSize(size);
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const target = 1.2; // meters
      const s = target / maxDim;
      root.scale.setScalar(s);
      resolve(root);
    }, undefined, (err)=>{
      log(`model load error: ${err.message || err.toString()}`);
      reject(err);
    });
  });
}

/* ---------- UI actions ---------- */
$('#btnAdd').addEventListener('click', async ()=>{
  if (!renderer.xr.isPresenting){
    log('Tip: Enter AR, move to find surface, then tap.');
    return;
  }
  // “Add” toggles “tap-to-place-next”
  setHint('Tap on the surface to place', true);
  pendingPlacement = await loadSelectedGLB().catch(()=>null);
});
$('#btnUndo').addEventListener('click', ()=>{
  const o = placed.pop();
  if (o){ o.parent?.remove(o); log('Undo: removed last object'); }
});
$('#btnClear').addEventListener('click', ()=>{
  while(placed.length){ placed.pop().parent?.remove(placed.pop()); }
  log('Cleared all placed objects');
});

let pendingPlacement = null;

/* ---------- Enter AR ---------- */
const btnAR = $('#enterAR');
btnAR.addEventListener('click', async ()=>{
  if (!navigator.xr){ log('WebXR not available'); return; }
  const ok = await navigator.xr.isSessionSupported('immersive-ar').catch(()=>false);
  if (!ok){ log('immersive-ar not supported'); return; }

  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test'],
    optionalFeatures: ['dom-overlay', 'unbounded'],
    domOverlay: { root: document.body }
  });

  renderer.xr.setReferenceSpaceType('local');
  await renderer.xr.setSession(session);
  log('AR session started. Move phone to find a surface; tap to place.');

  session.addEventListener('end', ()=>{
    log('AR session ended');
    reticle.visible = false;
    hitTestSourceRequested = false;
    hitTestSource = null;
    xrRefSpace = null;
    setHint('', false);
  });

  // Tap to place
  renderer.domElement.addEventListener('pointerdown', ()=>{
    if (reticle.visible && pendingPlacement){
      const obj = pendingPlacement.clone(true);
      obj.position.setFromMatrixPosition(reticle.matrix);
      obj.quaternion.setFromRotationMatrix(reticle.matrix);
      scene.add(obj);
      placed.push(obj);
      pendingPlacement = null;
      setHint('Placed. Tap Add to place another.', true);
      log('Object placed');
    }
  });
});

/* ---------- Hit-test + render loop ---------- */
const clock = new THREE.Clock();
renderer.setAnimationLoop((t, frame)=>{
  if (!frame){ renderer.render(scene, camera); return; }

  const session = renderer.xr.getSession();

  if (!hitTestSourceRequested){
    const viewerSpacePromise = session.requestReferenceSpace('viewer');
    viewerSpacePromise.then((viewerSpace)=>{
      session.requestHitTestSource({ space: viewerSpace }).then((source)=>{
        hitTestSource = source;
      });
    });
    session.requestReferenceSpace('local').then((refSpace)=>{ xrRefSpace = refSpace; });
    hitTestSourceRequested = true;
  }

  if (hitTestSource && xrRefSpace){
    const hitTestResults = frame.getHitTestResults(hitTestSource);
    if (hitTestResults.length){
      const hit = hitTestResults[0];
      const pose = hit.getPose(xrRefSpace);
      reticle.visible = true;
      reticle.matrix.fromArray(pose.transform.matrix);
      setHint('Tap to place', true);
    } else {
      reticle.visible = false;
      setHint('Move phone to find a surface…', true);
    }
  }

  renderer.render(scene, camera);
});

/* ---------- Resize ---------- */
addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

/* ---------- Double-tap shortcut to Enter AR ---------- */
let lastTap = 0;
addEventListener('touchend', ()=>{
  const now = performance.now();
  if (now - lastTap < 350) btnAR.click();
  lastTap = now;
}, { passive:true });

/* ---------- Initial status ---------- */
(async ()=>{
  const secure = location.protocol === 'https:' || location.hostname === 'localhost';
  const hasXR = !!navigator.xr;
  const immersive = hasXR ? await navigator.xr.isSessionSupported('immersive-ar').catch(()=>false) : false;
  log(`ready — secure:${secure} hasXR:${!!hasXR} immersive-ar:${!!immersive}`);
})();
</script>
</body>
</html>
