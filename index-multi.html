<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>AR Catalog â€” Multi Model</title>
  <style>
    :root { color-scheme: dark; }
    body, html { margin:0; height:100%; background:#0b0b0c; color:#e8e8ea; font-family: system-ui, sans-serif; }
    #topbar { position:fixed; inset:0 0 auto 0; padding:10px 12px; background:#111; border-bottom:1px solid #222; display:flex; gap:8px; align-items:center; z-index:2; }
    label { opacity:.9; }
    select { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2e; background:#161618; color:#e8e8ea; }
    .btn { padding:12px 16px; border:0; border-radius:12px; }
    .primary { background:#2d6df6; color:white; font-weight:700; }
    .muted   { background:#2a2a2e; color:#ddd; }
    #status { position:fixed; left:8px; right:8px; top:52px; font:12px/1.4 monospace; opacity:.85; z-index:2; }
    #stage { position:absolute; inset:0; }
    #enterAR { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; }
    canvas { display:block; width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="topbar">
    <label for="modelSelect">Model</label>
    <select id="modelSelect"><option>Loadingâ€¦</option></select>
    <button id="addBtn"  class="btn primary">+ Add</button>
    <button id="undoBtn" class="btn muted">âŸ² Undo</button>
    <button id="clearBtn" class="btn muted">ðŸ—‘ Clear</button>
  </div>
  <div id="status">bootâ€¦</div>
  <div id="stage"></div>
  <button id="enterAR" class="btn primary">ðŸ“· Enter AR</button>

  <script type="module">
    import * as THREE from './lib/three/build/three.module.js';
    import { GLTFLoader } from './lib/three/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from './lib/three/examples/jsm/loaders/DRACOLoader.js';

    const statusEl = document.getElementById('status');
    function log(m){ console.log(m); statusEl.textContent = m; }

    // Renderer / scene
    const stage = document.getElementById('stage');
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    stage.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.01, 100);
    camera.position.set(0, 1.2, 2.4);

    scene.add(new THREE.AmbientLight(0xffffff, .7));
    const sun = new THREE.DirectionalLight(0xffffff, 1.0);
    sun.position.set(2,4,2);
    scene.add(sun);

    window.addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    function tick(){ renderer.render(scene, camera); requestAnimationFrame(tick); }
    tick();

    // GLTF + DRACO
    const gltfLoader = new GLTFLoader();
    const draco = new DRACOLoader();
    draco.setDecoderPath('./lib/three/examples/jsm/libs/draco/');
    draco.setDecoderConfig({ type:'wasm' });
    gltfLoader.setDRACOLoader(draco);

    // Catalog
    const selectEl = document.getElementById('modelSelect');
    let catalog=[];
    try{
      const r = await fetch('./models/models.json');
      if(!r.ok) throw new Error('HTTP '+r.status);
      catalog = await r.json();
      if(!Array.isArray(catalog) && Array.isArray(catalog.models)) catalog = catalog.models;
      selectEl.innerHTML='';
      for(const item of catalog){
        const opt=document.createElement('option');
        opt.value=item.url; opt.textContent=item.name;
        selectEl.appendChild(opt);
      }
      log(`Catalog loaded âœ… (${catalog.length} items)`);
    }catch(e){
      log('Catalog load error: '+e.message);
      selectEl.innerHTML='<option>Failed to load catalog</option>';
    }

    // Non-AR staging area (lets you preview and stack multiple)
    const stagingRoot = new THREE.Group();
    scene.add(stagingRoot);
    const stack = [];

    async function addModel(url){
      const abs = new URL(url, location.href).href;
      log('Loading: '+url);
      const gltf = await gltfLoader.loadAsync(abs);
      const obj = gltf.scene;
      obj.traverse(n=>{ if(n.isMesh){ n.castShadow=true; n.receiveShadow=true; }});
      // normalize size
      const box = new THREE.Box3().setFromObject(obj);
      const size = new THREE.Vector3();
      box.getSize(size);
      const target = 1.2; // ~meterish preview
      const s = target / Math.max(size.x, size.y, size.z);
      obj.scale.setScalar(s);
      // center
      box.setFromObject(obj);
      const center = new THREE.Vector3();
      box.getCenter(center);
      obj.position.sub(center);

      stagingRoot.add(obj);
      stack.push(obj);
      log('Added âœ…  (stack: '+stack.length+')');
    }

    document.getElementById('addBtn').onclick = () => {
      const url = selectEl.value;
      if(url) addModel(url).catch(e=>log('Load error: '+e.message));
    };
    document.getElementById('undoBtn').onclick = ()=>{
      const m = stack.pop();
      if(m){ m.removeFromParent(); log('Undo âœ“ (stack: '+stack.length+')'); }
    };
    document.getElementById('clearBtn').onclick = ()=>{
      while(stack.length){ stack.pop().removeFromParent(); }
      log('Cleared âœ“');
    };

    // -------- WebXR: place the whole stagingRoot in AR, then tap to duplicate items
    const enterBtn = document.getElementById('enterAR');

    enterBtn.onclick = async () => {
      if(!navigator.xr){ log('WebXR not available'); return; }
      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      if(!supported){ log('immersive-ar not supported'); return; }

      const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures:['hit-test'] });
      renderer.xr.enabled = true;
      renderer.xr.setReferenceSpaceType('local');
      await renderer.xr.setSession(session);

      const refSpace = await session.requestReferenceSpace('local');
      const viewerSpace = await session.requestReferenceSpace('viewer');
      const hitSource = await session.requestHitTestSource({ space: viewerSpace });

      // reticle
      const retGeo = new THREE.RingGeometry(0.12,0.14,32).rotateX(-Math.PI/2);
      const retMat = new THREE.MeshBasicMaterial({ color:0x4da3ff });
      const reticle = new THREE.Mesh(retGeo, retMat); reticle.matrixAutoUpdate=false; reticle.visible=false;
      scene.add(reticle);

      // AR root where clones go
      const arRoot = new THREE.Group(); scene.add(arRoot);

      session.addEventListener('select', () => {
        if (!reticle.visible) return;
        // clone current staging
        const clone = stagingRoot.clone(true);
        clone.position.copy(reticle.position);
        clone.quaternion.copy(reticle.quaternion);
        arRoot.add(clone);
      });

      renderer.setAnimationLoop((t, frame)=>{
        if(frame){
          const hits = frame.getHitTestResults(hitSource);
          if(hits.length){
            const pose = hits[0].getPose(refSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        }
        renderer.render(scene, camera);
      });

      session.addEventListener('end', ()=>{
        renderer.setAnimationLoop(null);
        renderer.xr.enabled = false;
        reticle.removeFromParent();
        arRoot.removeFromParent();
        log('AR session ended');
      });
    };
  </script>
</body>
</html>
