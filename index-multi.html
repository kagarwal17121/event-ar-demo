<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AR Multi-Model</title>

<style>
  :root { color-scheme: dark; }
  body,html { margin:0; height:100%; background:#0b0b0f; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
  #app { display:flex; flex-direction:column; height:100%; }

  /* Top status bar */
  #statusBar { background:#10131a; padding:8px 12px; font-size:14px; color:#9fb1ff; border-bottom:1px solid #1c202a; }

  /* Controls panel */
  #controls { background:#141821; padding:10px; display:flex; flex-direction:column; gap:10px; }
  #controls select, #controls button { width:100%; height:44px; font-size:15px; border-radius:8px; border:none; }
  #controls select { background:#1d2230; color:#fff; }
  #controls button { background:#2563ff; color:#fff; font-weight:600; }
  #controls .row { display:flex; gap:8px; }
  #controls .row button { flex:1; }
  #controls button.secondary { background:#2a2f3b; }

  /* Stage (3D/AR view area) */
  #stage { flex:1; position:relative; background:#000; }
  #threeCanvas { width:100%; height:100%; display:block; }

  /* Bottom bar (Enter AR) */
  #bottomBar { padding:10px; background:#10131a; border-top:1px solid #1c202a; }
  #btnEnterAR { width:100%; height:50px; border-radius:10px; font-size:16px; font-weight:600; background:#2563ff; color:#fff; border:none; }
</style>

<script type="importmap">
{
  "imports": {
    "three": "./lib/three/build/three.module.js",
    "three/addons/": "./lib/three/examples/jsm/"
  }
}
</script>
</head>
<body>
<div id="app">

  <!-- Status strip -->
  <div id="statusBar">bootâ€¦</div>

  <!-- Controls -->
  <div id="controls">
    <select id="modelSelect" disabled><option>Loading catalogâ€¦</option></select>
    <button id="btnAdd" disabled>âž• Add Model</button>
    <div class="row">
      <button id="btnUndo" class="secondary" disabled>â†© Undo</button>
      <button id="btnClear" class="secondary" disabled>ðŸ—‘ Clear</button>
    </div>
  </div>

  <!-- 3D Stage -->
  <div id="stage">
    <canvas id="threeCanvas"></canvas>
  </div>

  <!-- Bottom bar -->
  <div id="bottomBar">
    <button id="btnEnterAR">ðŸ“· Enter AR</button>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

const ui = {
  status: document.getElementById('statusBar'),
  modelSelect: document.getElementById('modelSelect'),
  add: document.getElementById('btnAdd'),
  undo: document.getElementById('btnUndo'),
  clear: document.getElementById('btnClear'),
  enterAR: document.getElementById('btnEnterAR'),
  canvas: document.getElementById('threeCanvas')
};

function setStatus(txt){ ui.status.textContent = txt; }

// Scene basics
const renderer = new THREE.WebGLRenderer({canvas:ui.canvas, antialias:true, alpha:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight-160);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0,1.5,3);

const light = new THREE.HemisphereLight(0xffffff,0x444444,1.2);
scene.add(light);

const draco = new DRACOLoader().setDecoderPath('./lib/three/examples/jsm/libs/draco/');
const loader = new GLTFLoader().setDRACOLoader(draco);

let catalog = [];
let placed = [];

async function loadCatalog(){
  try {
    const res = await fetch('./models/models.json',{cache:'no-cache'});
    catalog = await res.json();
    ui.modelSelect.innerHTML = '';
    catalog.forEach((m,i)=>{
      const opt=document.createElement('option');
      opt.value=i; opt.textContent=m.name; ui.modelSelect.appendChild(opt);
    });
    ui.modelSelect.disabled=false;
    ui.add.disabled=false;
    setStatus('âœ… Catalog loaded');
  } catch(e){
    setStatus('âš  Failed to load catalog');
  }
}

ui.add.onclick = async ()=>{
  const item = catalog[ui.modelSelect.value];
  if(!item) return;
  setStatus('Loading '+item.name+'â€¦');
  try{
    const glb=await loader.loadAsync(item.url);
    const obj=glb.scene;
    obj.scale.setScalar(item.scale||1);
    obj.position.set(0,0,0);
    scene.add(obj);
    placed.push(obj);
    ui.undo.disabled=false;
    ui.clear.disabled=false;
    setStatus('âœ… Added '+item.name);
  }catch(e){ setStatus('âš  Error '+e.message); }
};

ui.undo.onclick=()=>{
  const o=placed.pop();
  if(o) scene.remove(o);
  if(placed.length===0){ ui.undo.disabled=true; ui.clear.disabled=true; }
};

ui.clear.onclick=()=>{
  placed.forEach(o=>scene.remove(o));
  placed.length=0;
  ui.undo.disabled=true; ui.clear.disabled=true;
};

function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
animate();

ui.enterAR.onclick=()=>{
  alert('AR session would start here (WebXR hit-test).');
};

loadCatalog();
</script>
</body>
</html>
