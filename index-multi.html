<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Event AR ‚Äì Multi Model</title>
<style>
  :root { --ui:#111; --ink:#fff; --accent:#1976ff; }
  html,body{margin:0;height:100%;background:#000;color:var(--ink);font-family:Inter,system-ui,Arial;}
  #log{position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,.65);padding:.4rem .6rem;font-size:.8rem;z-index:30;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  #ui{position:fixed;top:42px;left:0;right:0;background:linear-gradient(#f7f7f7,#eee);color:#111;padding:.8rem .8rem 0;z-index:20;box-shadow:0 2px 12px rgba(0,0,0,.12)}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin:0 0 .8rem}
  select,button{height:48px;border-radius:12px;border:1px solid #d0d0d0;background:#fff;font-size:16px}
  select{padding:0 .8rem;flex:1;min-width:180px}
  .btn{padding:0 18px;display:inline-flex;align-items:center;gap:.5rem}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.danger{background:#fff;color:#333}
  #enterAR{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);z-index:25}
  canvas{display:block}
  #reticle{display:none}
</style>
</head>
<body>

<div id="log">boot‚Ä¶</div>

<div id="ui">
  <div class="row">
    <label for="modelSel" style="color:#444;margin-right:.4rem">Model</label>
    <select id="modelSel"><option>Loading‚Ä¶</option></select>
  </div>
  <div class="row">
    <button id="addBtn" class="btn primary">‚ûï Add</button>
    <button id="undoBtn" class="btn">‚Ü∫ Undo</button>
    <button id="clearBtn" class="btn danger">üóëÔ∏è Clear</button>
  </div>
</div>

<button id="enterAR" class="btn primary">üì∑ Enter AR</button>

<!-- three.js (local) -->
<script type="module">
/* ---------- Imports (LOCAL files) ---------- */
import * as THREE from './lib/three/three.module.js';
import { GLTFLoader } from './lib/three/examples/jsm/loaders/GLTFLoader.js?v=2';
import { DRACOLoader } from './lib/three/examples/jsm/loaders/DRACOLoader.js?v=2';

/* ---------- DOM ---------- */
const $ = s => document.querySelector(s);
const log = (m) => { const t = new Date().toTimeString().slice(0,8); $('#log').textContent = `${t} ‚Äî ${m}`; };

const sel = $('#modelSel');
const addBtn = $('#addBtn');
const undoBtn = $('#undoBtn');
const clearBtn = $('#clearBtn');
const enterBtn = $('#enterAR');

/* ---------- Three scene ---------- */
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 50);

const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
scene.add(hemi);

/* Reticle */
const reticle = new THREE.Mesh(
  new THREE.RingGeometry(0.12, 0.15, 32).rotateX(-Math.PI/2),
  new THREE.MeshBasicMaterial({ color: 0x26a0ff })
);
reticle.visible = false;
scene.add(reticle);

/* ---------- Loaders ---------- */
const loadingManager = new THREE.LoadingManager();
const gltfLoader = new GLTFLoader(loadingManager);

// DRACO support
const draco = new DRACOLoader();
draco.setDecoderPath('./lib/three/examples/jsm/libs/draco/'); // contains draco_decoder.wasm/js
draco.setDecoderConfig({ type: 'wasm' });
gltfLoader.setDRACOLoader(draco);

const cache = new Map(); // url -> GLTF scene (clonable)

<!-- ---------- Catalog (inline, no fetch) ---------- -->
<script type="module">
/* Put this right after the other <script type="module"> content,
   or merge into it. If merging, remove the old loadCatalog() and
   its call. */

const CATALOG = [
  { name: "Podium",         url: "./models/podium.glb" },
  { name: "Concert Stage",  url: "./models/concert-stage.glb" },
  { name: "Chair",          url: "./models/chair.glb" },
  { name: "Couch",          url: "./models/couch.glb" },
  { name: "Chaise",         url: "./models/chaisehighpoly.glb" }
];

// wire up the existing DOM + log() from the main script
const sel = document.querySelector('#modelSel');
const log = (m)=>{ const t=new Date().toTimeString().slice(0,8); document.querySelector('#log').textContent=`${t} ‚Äî ${m}`; };

function populateCatalog(list) {
  sel.innerHTML = '';
  for (const item of list) {
    const opt = document.createElement('option');
    opt.value = item.url;
    opt.textContent = item.name;
    sel.appendChild(opt);
  }
  log(`Catalog loaded (${list.length} items)`);
}

populateCatalog(CATALOG);
</script>

/* ---------- Helpers ---------- */
function loadModel(url) {
  return new Promise((resolve, reject) => {
    if (cache.has(url)) return resolve(cache.get(url).clone(true));
    gltfLoader.load(url, (gltf) => {
      cache.set(url, gltf.scene);
      resolve(gltf.scene.clone(true));
    }, undefined, (err) => reject(err));
  });
}

/* ---------- XR Setup ---------- */
let xrSession = null;
let refSpace = null;
let hitTestSource = null;
const placed = []; // stack for undo

async function enterAR() {
  if (!navigator.xr) { log('WebXR not available'); return; }
  try {
    const supported = await navigator.xr.isSessionSupported('immersive-ar');
    log(`immersive-ar: ${supported}`);
    if (!supported) return;

    xrSession = await navigator.xr.requestSession('immersive-ar', { requiredFeatures:['hit-test'] });
    renderer.xr.setReferenceSpaceType('local');
    await renderer.xr.setSession(xrSession);

    const viewerSpace = await xrSession.requestReferenceSpace('viewer');
    hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });
    refSpace = await xrSession.requestReferenceSpace('local');

    xrSession.addEventListener('end', onSessionEnd);
    renderer.setAnimationLoop(onXRFrame);

    // Tap to place
    renderer.domElement.addEventListener('click', handlePlace);
  } catch (e) {
    log(`enterAR error: ${e.message}`);
  }
}

function onSessionEnd() {
  renderer.setAnimationLoop(null);
  hitTestSource = null;
  xrSession = null;
  reticle.visible = false;
  log('AR session ended');
}

async function handlePlace() {
  if (!reticle.visible) return;
  const url = sel.value;
  try {
    const obj = await loadModel(url);
    obj.position.copy(reticle.position);
    obj.quaternion.copy(reticle.quaternion);
    obj.scale.setScalar(1); // adjust default scale here if needed
    scene.add(obj);
    placed.push(obj);
  } catch (e) {
    toast(`Failed to load:\n${url}`);
    log(`model load error: ${e.message}`);
  }
}

/* ---------- Buttons ---------- */
addBtn.onclick = handlePlace;
undoBtn.onclick = () => { const o = placed.pop(); if (o) scene.remove(o); };
clearBtn.onclick = () => { while (placed.length) scene.remove(placed.pop()); };
enterBtn.onclick = enterAR;

/* ---------- Frame loop ---------- */
function onXRFrame(t, frame) {
  const ref = refSpace;
  const viewerPose = frame.getViewerPose(ref);
  if (!viewerPose || !hitTestSource) {
    renderer.render(scene, camera);
    return;
  }
  const hits = frame.getHitTestResults(hitTestSource);
  if (hits.length) {
    const hit = hits[0];
    const pose = hit.getPose(ref);
    reticle.visible = true;
    reticle.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
    reticle.updateMatrixWorld(true);
  } else {
    reticle.visible = false;
  }
  renderer.render(scene, camera);
}

/* ---------- Resize ---------- */
addEventListener('resize', () => {
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
});

/* ---------- Tiny toast ---------- */
function toast(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed'; el.style.left='50%'; el.style.bottom='84px'; el.style.transform='translateX(-50%)';
  el.style.background='rgba(0,0,0,.7)'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='12px'; el.style.zIndex=40;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 2200);
}
</script>
</body>
</html>
